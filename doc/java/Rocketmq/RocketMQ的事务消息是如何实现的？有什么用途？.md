# RocketMQ 的事务消息是如何实现的？有什么用途？

RocketMQ的事务消息是通过两阶段提交（Two-phase Commit）协议实现的。具体实现步骤如下：

1. 发送方将半事务消息发送至RocketMQ服务端，由于消息为半事务消息，在未收到生产者对该消息的二次确认前，此消息被标记成“暂不能投递”状态，不会被消费。
2. 发送方开始执行本地事务逻辑。可能是一系列的数据库更新、文件写入等操作，他们要么全部成功，要么全部回滚。
3. 发送方根据本地事务执行结果向服务端提交二次确认（Commit 或是 Rollback），服务端收到 Commit 状态则将半事务消息标记为可投递，订阅方最终将收到该消息；服务端收到 Rollback 状态则删除半事务消息，订阅方将不会接受该消息。
4. 如果二次确认时，发送方的本地事务没有执行完成，则可以向服务端返回 Unknown 状态，服务端收到 Unknown 状态则会等一段时间后，重新向发送放发起状态确认。如果发送方多次返回 Unknown 状态，服务端则会直接丢弃这一条消息。

RocketMQ 的事务消息机制是为了解决分布式事务问题而设计的，它适用于需要确保一系列操作的一致性的场景，如订单支付、库存扣减、资金结算等。主要的用途有：

1. **分布式事务：** 事务消息用于支持分布式系统中的分布式事务。它可以确保涉及多个操作的事务要么全部成功，要么全部失败，以维护数据的一致性。典型的应用包括订单支付、库存扣减、资金结算等。
2. **消息可靠性：** 事务消息与普通消息一样，具有消息的可靠性传递特性。一旦事务消息被成功发送到 RocketMQ 服务器，它将被存储和传递，不会丢失。
3. **Exactly Once 语义：** RocketMQ 事务消息提供了"Exactly Once"语义，确保消息要么完全提交，要么完全回滚，不会出现部分提交或回滚的情况。

使用事务消息，您可以更好地处理这些复杂的业务流程，确保数据的完整性和一致性。但请注意，事务消息也需要谨慎使用，因为它可能会引入一些复杂性，并影响系统的性能和可伸缩性。


> 原文: <https://www.yuque.com/tulingzhouyu/db22bv/lplcgplbp8gkekgl>